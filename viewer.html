<!--
    Name: Trung
    Assignment 5: Interactive WebGL Viewer
-->

<!DOCTYPE html>
<html>
<head>
    <title>Assignment 5: Interactive WebGL Viewer</title>
    <style>
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .author {
            margin-bottom: 20px;
        }

        .author p {
            margin: 5px 0;
        }

        canvas {
            border: 1px solid #ccc;
            margin: 20px 0;
            background-color: #f0f0f0;
        }

        .controls {
            margin: 20px 0;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }

        .slider-container {
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .slider-container input[type="range"] {
            flex: 1;
        }

        .slider-container label {
            width: 60px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Interactive WebGL Viewer</h1>
        <div class="author">
            <p>Trung</p>
        </div>
        
        <canvas id="glCanvas" width="800" height="600"></canvas>
        
        <div class="controls">
            <div class="slider-container">
                <label>theta -180</label>
                <input id="thetaSlider" type="range" min="-180" max="180" step="1" value="0">
                <label>180</label>
            </div>
            
            <div class="slider-container">
                <label>phi -180</label>
                <input id="phiSlider" type="range" min="-180" max="180" step="1" value="0">
                <label>180</label>
            </div>
            
            <div class="slider-container">
                <label>radius 0.05</label>
                <input id="radiusSlider" type="range" min="0.05" max="5" step="0.1" value="2">
                <label>5</label>
            </div>
            
            <div class="slider-container">
                <label>depth 0.05</label>
                <input id="depthSlider" type="range" min="0.05" max="3" step="0.1" value="2">
                <label>3</label>
            </div>
        </div>
    </div>

    <!-- Vertex shader -->
    <script id="vertex-shader" type="x-shader/x-vertex">
        attribute vec4 aPosition;
        attribute vec4 aColor;
        varying vec4 vColor;
        uniform mat4 uModelViewMatrix;
        uniform mat4 uProjectionMatrix;
        
        void main() {
            vColor = aColor;
            gl_Position = uProjectionMatrix * uModelViewMatrix * aPosition;
        }
    </script>

    <!-- Fragment shader -->
    <script id="fragment-shader" type="x-shader/x-fragment">
        precision mediump float;
        varying vec4 vColor;
        
        void main() {
            gl_FragColor = vColor;
        }
    </script>

    <!-- Load GL Matrix library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gl-matrix/2.8.1/gl-matrix-min.js"></script>

    <!-- Main program -->
    <script>
        let gl;
        let program;

        // View parameters
        let theta = 0;
        let phi = 0;
        let radius = 2;
        let near = -1;
        let far = 1;
        let left = -1;
        let right = 1;
        let bottom = -1;
        let ytop = 1;

        // Fixed camera parameters
        const at = [0.0, 0.0, 0.0];
        const up = [0.0, 1.0, 0.0];

        // Initialize WebGL when the window loads
        window.onload = function init() {
            const canvas = document.querySelector('#glCanvas');
            gl = canvas.getContext('webgl');

            if (!gl) {
                alert('Unable to initialize WebGL. Your browser may not support it.');
                return;
            }

            // Set up WebGL
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
            gl.clearColor(0.9, 0.9, 0.9, 1.0);
            gl.enable(gl.DEPTH_TEST);

            // Initialize shaders and buffers
            program = initShaderProgram();
            const buffers = initBuffers();
            
            // Set up event listeners
            setupEventListeners();
            
            // Start rendering
            render(buffers);
        }

        function setupEventListeners() {
            document.getElementById('thetaSlider').onchange = function(event) {
                theta = event.target.value * Math.PI / 180;
            };

            document.getElementById('phiSlider').onchange = function(event) {
                phi = event.target.value * Math.PI / 180;
            };

            document.getElementById('radiusSlider').onchange = function(event) {
                radius = event.target.value;
            };

            document.getElementById('depthSlider').onchange = function(event) {
                far = event.target.value/2;
                near = -event.target.value/2;
            };
        }

        function render(buffers) {
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);

            // Calculate eye position in polar coordinates
            const eye = [
                radius * Math.sin(theta) * Math.cos(phi),
                radius * Math.sin(theta) * Math.sin(phi),
                radius * Math.cos(theta)
            ];

            // Create model-view and projection matrices
            const modelViewMatrix = mat4.create();
            const projectionMatrix = mat4.create();

            mat4.lookAt(modelViewMatrix, eye, at, up);
            mat4.ortho(projectionMatrix, left, right, bottom, ytop, near, far);

            // Set uniforms
            gl.uniformMatrix4fv(
                gl.getUniformLocation(program, 'uModelViewMatrix'),
                false,
                modelViewMatrix);
                
            gl.uniformMatrix4fv(
                gl.getUniformLocation(program, 'uProjectionMatrix'),
                false,
                projectionMatrix);

            // Draw
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, buffers.indices);
            gl.drawElements(gl.TRIANGLES, 36, gl.UNSIGNED_SHORT, 0);

            requestAnimationFrame(() => render(buffers));
        }

        function initBuffers() {
            // Create cube vertices
            const positions = [
                // Front face
                -0.5, -0.5,  0.5,
                 0.5, -0.5,  0.5,
                 0.5,  0.5,  0.5,
                -0.5,  0.5,  0.5,
                
                // Back face
                -0.5, -0.5, -0.5,
                -0.5,  0.5, -0.5,
                 0.5,  0.5, -0.5,
                 0.5, -0.5, -0.5,
                
                // Top face
                -0.5,  0.5, -0.5,
                -0.5,  0.5,  0.5,
                 0.5,  0.5,  0.5,
                 0.5,  0.5, -0.5,
                
                // Bottom face
                -0.5, -0.5, -0.5,
                 0.5, -0.5, -0.5,
                 0.5, -0.5,  0.5,
                -0.5, -0.5,  0.5,
                
                // Right face
                 0.5, -0.5, -0.5,
                 0.5,  0.5, -0.5,
                 0.5,  0.5,  0.5,
                 0.5, -0.5,  0.5,
                
                // Left face
                -0.5, -0.5, -0.5,
                -0.5, -0.5,  0.5,
                -0.5,  0.5,  0.5,
                -0.5,  0.5, -0.5,
            ];

            const positionBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(positions), gl.STATIC_DRAW);

            // Set up colors
            const faceColors = [
                [1.0, 0.0, 0.0, 1.0],    // Front: red
                [0.0, 1.0, 0.0, 1.0],    // Back: green
                [0.0, 0.0, 1.0, 1.0],    // Top: blue
                [1.0, 1.0, 0.0, 1.0],    // Bottom: yellow
                [1.0, 0.0, 1.0, 1.0],    // Right: purple
                [0.0, 1.0, 1.0, 1.0],    // Left: cyan
            ];

            let colors = [];
            for (let j = 0; j < faceColors.length; ++j) {
                const c = faceColors[j];
                colors = colors.concat(c, c, c, c);
            }

            const colorBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
            gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(colors), gl.STATIC_DRAW);

            // Set up indices
            const indices = [
                0,  1,  2,    0,  2,  3,    // Front
                4,  5,  6,    4,  6,  7,    // Back
                8,  9,  10,   8,  10, 11,   // Top
                12, 13, 14,   12, 14, 15,   // Bottom
                16, 17, 18,   16, 18, 19,   // Right
                20, 21, 22,   20, 22, 23,   // Left
            ];

            const indexBuffer = gl.createBuffer();
            gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, indexBuffer);
            gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, new Uint16Array(indices), gl.STATIC_DRAW);

            // Set up attributes
            gl.bindBuffer(gl.ARRAY_BUFFER, positionBuffer);
            gl.vertexAttribPointer(
                gl.getAttribLocation(program, 'aPosition'),
                3,          // numComponents
                gl.FLOAT,   // type
                false,      // normalize
                0,          // stride
                0           // offset
            );
            gl.enableVertexAttribArray(gl.getAttribLocation(program, 'aPosition'));

            gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
            gl.vertexAttribPointer(
                gl.getAttribLocation(program, 'aColor'),
                4,          // numComponents
                gl.FLOAT,   // type
                false,      // normalize
                0,          // stride
                0           // offset
            );
            gl.enableVertexAttribArray(gl.getAttribLocation(program, 'aColor'));

            return {
                position: positionBuffer,
                color: colorBuffer,
                indices: indexBuffer,
            };
        }

        function initShaderProgram() {
            const vertexShader = loadShader(gl, gl.VERTEX_SHADER, 
                document.getElementById('vertex-shader').text);
            const fragmentShader = loadShader(gl, gl.FRAGMENT_SHADER, 
                document.getElementById('fragment-shader').text);

            const shaderProgram = gl.createProgram();
            gl.attachShader(shaderProgram, vertexShader);
            gl.attachShader(shaderProgram, fragmentShader);
            gl.linkProgram(shaderProgram);

            if (!gl.getProgramParameter(shaderProgram, gl.LINK_STATUS)) {
                alert('Unable to initialize the shader program: ' + 
                    gl.getProgramInfoLog(shaderProgram));
                return null;
            }

            gl.useProgram(shaderProgram);
            return shaderProgram;
        }

        function loadShader(gl, type, source) {
            const shader = gl.createShader(type);
            gl.shaderSource(shader, source);
            gl.compileShader(shader);

            if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
                alert('An error occurred compiling the shaders: ' + 
                    gl.getShaderInfoLog(shader));
                gl.deleteShader(shader);
                return null;
            }

            return shader;
        }
    </script>
</body>
</html>